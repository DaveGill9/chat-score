import { Controller, Get, Res, HttpStatus, HttpCode } from '@nestjs/common';
import type { Response } from 'express';
import { ConfigService } from '@nestjs/config';
import { Public } from '../users';

@Controller()
@Public()
export class HealthController {
  constructor(private readonly configService: ConfigService) {}

  @Get()
  @HttpCode(HttpStatus.OK)
  getRoot() {
    const version = this.configService.get<string>('APP_VERSION', '0.0.0');
    return {
      status: 'OK',
      version,
      timestamp: new Date().toISOString(),
    };
  }

  @Get('healthz')
  @HttpCode(HttpStatus.OK)
  getHealth() {
    const version = this.configService.get<string>('APP_VERSION', '0.0.0');    
    return {
      status: 'OK',
      version,
      timestamp: new Date().toISOString()
    };
  }

  /* Common files - prevent 404 errors */

  @Get('favicon.ico')
  getFavicon(@Res() res: Response) {
    const svgFavicon = `
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 38.792 38.793">  
        <path d="M19.396,0C8.701,0,0,8.701,0,19.396s8.701,19.396,19.396,19.396,19.396-8.701,19.396-19.396S30.091,0,19.396,0ZM19.396,36.293c-9.317,0-16.896-7.58-16.896-16.896S10.08,2.5,19.396,2.5s16.896,7.58,16.896,16.896-7.58,16.896-16.896,16.896Z"/>
        <path d="M14.262,15.42c-.49-.486-1.281-.484-1.768.005-.01.01-.013.024-.023.034-.015.014-.035.018-.05.033l-1.732,1.722c-.489.487-.492,1.278-.005,1.768.245.246.565.369.887.369.195,0,.383-.061.561-.152v7.753c0,.69.56,1.25,1.25,1.25s1.25-.56,1.25-1.25v-7.774c.154.065.317.1.482.1.321,0,.642-.123.887-.369.486-.49.484-1.281-.005-1.768l-1.732-1.722Z"/>
        <path d="M16.472,11.922h-6.254c-.69,0-1.25.56-1.25,1.25s.56,1.25,1.25,1.25h6.254c.69,0,1.25-.56,1.25-1.25s-.56-1.25-1.25-1.25Z"/>
        <path d="M28.003,10.631c-.202-.439-.721-.632-1.161-.43l-7.012,3.219c-.359.109-.626.43-.626.825,0,.41.288.738.668.833.027.008.054.011.082.016.043.006.081.025.125.025h3.652l-3.901,1.791c-.359.109-.626.43-.626.825,0,.41.288.738.668.833.027.008.054.011.082.016.043.006.081.025.125.025h3.124l-3.373,1.549c-.359.109-.626.43-.626.825,0,.41.288.739.668.834.027.008.054.011.082.017.043.006.081.025.125.025h3.124l-3.371,1.548c-.36.108-.628.429-.628.825,0,.41.288.739.669.833.026.008.054.011.081.016.043.006.081.025.126.025h3.126l-3.373,1.549c-.36.108-.628.429-.628.825,0,.41.288.739.669.833.026.008.054.011.081.016.043.006.081.025.126.025h7.128c.483,0,.875-.392.875-.875s-.392-.875-.875-.875h-3.074l3.414-1.568s0,0,0,0l.024-.011c.038-.017.063-.049.097-.071.059-.038.119-.072.167-.122.039-.041.063-.091.094-.139.03-.047.066-.089.087-.142.026-.065.031-.134.041-.203.006-.04.024-.076.024-.118,0-.004-.002-.008-.002-.012,0-.059-.022-.117-.036-.177-.013-.055-.016-.113-.038-.163-.002-.004-.001-.009-.003-.013-.018-.039-.051-.066-.074-.101-.037-.057-.07-.117-.12-.164-.039-.037-.087-.06-.132-.089-.049-.032-.094-.07-.15-.092-.063-.025-.13-.03-.197-.04-.042-.006-.079-.025-.123-.025h-3.073l3.438-1.578c.039-.018.064-.05.099-.072.058-.038.118-.071.166-.121.039-.041.063-.091.094-.139.03-.047.066-.09.087-.142.026-.065.031-.134.041-.203.006-.04.024-.076.024-.118,0-.004-.002-.008-.002-.012,0-.059-.022-.117-.036-.177-.013-.055-.016-.113-.038-.163-.002-.004-.001-.009-.003-.013-.019-.041-.053-.069-.077-.105-.036-.055-.068-.113-.116-.159-.042-.04-.093-.065-.142-.096-.046-.029-.088-.064-.139-.085-.065-.026-.135-.031-.204-.041-.04-.006-.076-.024-.117-.024h-3.072l3.437-1.578c.041-.019.068-.052.104-.076.056-.037.114-.069.16-.117.04-.042.064-.092.095-.141.03-.047.065-.089.086-.141.026-.065.031-.134.041-.203.006-.04.024-.076.024-.118,0-.004-.002-.008-.002-.012,0-.059-.022-.117-.036-.177-.013-.055-.016-.113-.038-.163-.002-.004-.001-.009-.003-.013-.019-.041-.052-.068-.076-.105-.036-.056-.068-.114-.116-.159-.042-.04-.092-.064-.14-.095-.047-.03-.089-.065-.141-.086-.063-.025-.131-.03-.199-.04-.042-.006-.079-.025-.122-.025h-3.073l3.438-1.579c.361-.166.542-.547.486-.922.005-.04.023-.075.023-.116,0-.483-.392-.875-.875-.875h-3.072l3.437-1.578c.439-.202.632-.721.43-1.161Z"/>
      </svg>`.replace(/[\s]+/, ' ').trim();
    res.setHeader('Content-Type', 'image/svg+xml');
    res.setHeader('Cache-Control', 'public, max-age=86400');
    res.send(svgFavicon);
  }

  @Get('robots.txt')
  getRobots(@Res() res: Response) {
    const robotsContent = 'User-agent: *\nDisallow: *';
    res.setHeader('Content-Type', 'text/plain');
    res.setHeader('Cache-Control', 'public, max-age=86400');
    res.send(robotsContent);
  }

  @Get('sitemap.xml')
  getSitemap(@Res() res: Response) {
    const emptySitemap = `<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n</urlset>`;    
    res.setHeader('Content-Type', 'application/xml');
    res.setHeader('Cache-Control', 'public, max-age=86400');
    res.send(emptySitemap);
  }
} 